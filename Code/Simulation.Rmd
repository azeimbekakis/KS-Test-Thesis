---
title: "R Notebook"
output: html_notebook
---

```{r}
library(xtable)
library(dgof)
library(tidyverse)
```

```{r}
# Testing a simple random normal distribution
test_normal <- function(n_tests, n_samples) {
  p_values <- c()
  for(i in 1:n_tests) {
    data <- rnorm(n_samples)
    p_values[i] <- ks.test(data, "pnorm")$p.value
  }
  results <- data.frame(p_values)
  bins <- 1 + 3.322 * log(n_tests)
  hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="black", fill="grey", bins = bins)
  return(hist)
}

test_normal(10000, 10)
test_normal(10000, 100)
test_normal(10000, 1000)
test_normal(10, 10000)
test_normal(100, 10000)
test_normal(1000, 10000)
```

```{r}
test_rounded <- function(n_tests, n_samples, rounded) {
  p_values <- c()
  for(i in 1:n_tests) {
    data <- round(rnorm(n_samples), rounded)
    p_values[i] <- ks.test(data, "pnorm")$p.value
  }
  results <- data.frame(p_values)
  h <- hist(p_values, breaks = "FD", plot = FALSE)
  hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="black", fill="grey", breaks = h$breaks)
  return(hist)
}

suppressWarnings(test_rounded(1000, 10000, 4))
suppressWarnings(test_rounded(1000, 10000, 3))
suppressWarnings(test_rounded(1000, 10000, 2))
suppressWarnings(test_rounded(1000, 10000, 1))
test_plot <- suppressWarnings(test_rounded(1000, 10000, 1))
ggsave(filename="test_plot.pdf", plot=test_plot)
```

```{r}
test_correlation <- function(n_tests, ars) {
  for(i in 1:length(ars)) {
    ar_results <- numeric(n_tests)
    for(j in 1:n_tests) {
      data <- arima.sim(model = list(ar = ars[i]), rand.gen = rnorm, sd = sqrt(1-ars[i]^2), n = 500)
      ar_results[j] <- ks.test(data, "pnorm")$p.value
    }
    hist_title <- paste("AR coefficient", ars[i])
    hist(ar_results, main = hist_title, xlab = "P-value")
  }
}

ars <- seq(-0.5, 0.5, by = 0.1)
suppressWarnings(test_correlation(1000, ars))
```

```{r}
check_var <- function(phi) {
  data <- arima.sim(model = list(ar = phi), rand.gen = rnorm, sd = sqrt(1-phi^2), n = 10000)
  cat("ar = ", phi, "\n")
  cat("var = ", var(data), "\n")
  cat("sd = ", sd(data), "\n")
  cat("-----", "\n")
}
```

```{r}
test_table <- function(n_tests, n_samples) {
  results <- numeric(n_tests)
  for(i in 1:n_tests) {
    data <- rnorm(n_samples)
    results[i] <- ks.test(data, "pnorm")$p.value
  }
  power_level <- 1 - sum(results < 0.05) / n_tests
  return(power_level)
}
Tests_Samples <- c("10000, 10", "10000, 100", "10000, 1000", "10, 10000", "100, 10000", "1000, 10000")
Power_Level <- c(0, 0, 0, 0, 0, 0)
tab <- data.frame(Tests_Samples, Power_Level)
tab[1, "Power_Level"] <- test_table(10000, 10)
tab[2, "Power_Level"] <- test_table(10000, 100)
tab[3, "Power_Level"] <- test_table(10000, 1000)
tab[4, "Power_Level"] <- test_table(10, 10000)
tab[5, "Power_Level"] <- test_table(100, 10000)
tab[6, "Power_Level"] <- test_table(1000, 10000)
tab <- xtable(tab)
tab
```

```{r}
y <- pnorm(seq(-10.1, 10, by = .1))
sfun  <- stepfun(seq(-10, 10, by = .1), y)
plot(y)
plot(sfun)
```

```{r}
test_dgof <- function(n_tests, n_samples, rounded, B = 100) {
  results1 <- c()
  results2 <- c()
  results3 <- c()
  left <- -10-rounded*0.1
  y <- pnorm(seq(left, 10, by = rounded*0.1))
  sfun  <- stepfun(seq(-10, 10, by = rounded*0.1), y)
  for (i in 1:n_tests) {
    test <- round(rnorm(n_samples), rounded)
    cat(i)
    results1[i] <- ks.test(test, sfun)$p.value
    results2[i] <- ks.test(test, sfun, simulate.p.value = TRUE, B = B)$p.value
    results3[i] <- ks.test(test, "pnorm")$p.value
  }
  hist(results1, xlab = "P-value")
  hist(results2, xlab = "P-value")
  hist(results3, xlab = "P-value")
}

#suppressWarnings(test_dgof(1000, 30, 4))
#suppressWarnings(test_dgof(1000, 30, 3))
suppressWarnings(test_dgof(1000, 30, 2))
suppressWarnings(test_dgof(1000, 30, 1))
```

```{r}
test_dgofsimulate <- function(n_tests, n_samples, rounded, B = 100) {
  results1 <- c()
  results2 <- c()
  left <- -10-rounded*0.1
  y <- pnorm(seq(left, 10, by = rounded*0.1))
  sfun  <- stepfun(seq(-10, 10, by = rounded*0.1), y)
  for (i in 1:n_tests) {
    test <- round(rnorm(n_samples), rounded)
    cat(i)
    results1[i] <- ks.test(test, sfun)$p.value
    results2[i] <- ks.test(test, sfun, simulate.p.value = TRUE, B = B)$p.value
  }
  hist(results1, xlab = "P-value")
  hist(results2, xlab = "P-value")
}

suppressWarnings(test_dgofsimulate(1000, 100, 1, 100))
suppressWarnings(test_dgofsimulate(1000, 100, 2, 100))
```

```{r}
test_parametric <- function(x, B = 200) {
  mu <- mean(x)
  sigma <- sd(x)
  stat <- ks.test(x, "pnorm", mu, sigma)$statistic
  n <- length(x)
  stat.b <- double(B)
  for (i in 1:B) {
    x.b <- rnorm(n, mu, sigma)
    mu.b <- mean(x.b)
    sigma.b <- sd(x.b)
    stat.b[i] <- ks.test(x.b, "pnorm", mu.b, sigma.b)$statistic
  }
  p.value <- (sum(stat.b >= stat) + 0.5) / (B + 1)
  list(statistics = stat, p.value = p.value, 
       estimate = c(mean = mu, sd = sigma),
       stat.sim = stat.b)
}

pvals_parametric <- replicate(1000, test_parametric(rnorm(100), B = 200)$p.value)

test_ks <- function(x) {
  p.value <- ks.test(x, "pnorm", mean = mean(x), sd = sd(x))$p.value
  list(p.value = p.value)
}

pvals_regular <- replicate(1000, test_ks(rnorm(100))$p.value)

hist(pvals_parametric)
hist(pvals_regular)
```

```{r}
ks.test(pvals_parametric, "punif")
ks.test(pvals_regular, "punif")
```
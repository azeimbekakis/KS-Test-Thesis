---
title: "R Notebook"
output: html_notebook
---

```{r}
library(xtable)
library(dgof)
library(tidyverse)
```

```{r}
# Testing a simple random normal distribution
test_normal <- function(n_tests, n_samples) {
  p_values <- c()
  for(i in 1:n_tests) {
    data <- rnorm(n_samples)
    p_values[i] <- ks.test(data, "pnorm")$p.value
  }
  return(p_values)
}

hist1 <- test_normal(10000, 10)
hist2 <- test_normal(10000, 100)
hist3 <- test_normal(10000, 1000)
hist4 <- test_normal(10, 10000)
hist5 <- test_normal(100, 10000)
hist6 <- test_normal(1000, 10000)

histogram <- c(rep("hist1", 10000), rep("hist2", 10000), rep("hist3", 10000), rep("hist4", 10), rep("hist5", 100), rep("hist6", 1000))
p_values <- c(hist1, hist2, hist3, hist4, hist5, hist6)
results <- data_frame(p_values, histogram)
hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="gray", fill="white", bins = 20)
hist + facet_wrap(.~histogram, scales = "free_y")
```

```{r}
test_rounded <- function(n_tests, n_samples, rounded) {
  p_values <- c()
  for(i in 1:n_tests) {
    data <- round(rnorm(n_samples), rounded)
    p_values[i] <- ks.test(data, "pnorm")$p.value
  }
  return(p_values)
}

hist1 <- suppressWarnings(test_rounded(10000, 10000, 4))
hist2 <- suppressWarnings(test_rounded(10000, 10000, 3))
hist3 <- suppressWarnings(test_rounded(10000, 10000, 2))
hist4 <- suppressWarnings(test_rounded(10000, 10000, 1))
#ggsave(filename="test_plot.pdf", plot=test_plot)
histogram <- c(rep("hist1", 10000), rep("hist2", 10000), rep("hist3", 10000), rep("hist4", 10000))
p_values <- c(hist1, hist2, hist3, hist4)
results <- data_frame(p_values, histogram)
hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="gray", fill="white", bins = 20)
hist + facet_wrap(.~histogram, scales = "free_y")
```

```{r}
test_correlation <- function(n_tests, ars) {
  columns <- c("p_value", "ar")
  ar_results <- data.frame(matrix(ncol = 2, nrow = 0))
  colnames(ar_results) <- columns
  for(i in 1:length(ars)) {
    for(j in 1:n_tests) {
      data <- arima.sim(model = list(ar = ars[i]), rand.gen = rnorm, sd = sqrt(1-ars[i]^2), n = 500)
      ar_results <- add_row(ar_results, p_value = ks.test(data, "pnorm")$p.value, ar = ars[i])
    }
  }
  return(ar_results)
}

ars <- seq(-0.5, 0.5, by = 0.1)
ar_results <- suppressWarnings(test_correlation(1000, ars))
```

```{r}
hist <- ggplot(ar_results, aes(x = p_value)) + geom_histogram(color="gray", fill="white", bins = 20)
hist + facet_wrap(.~ar)
```
```{r}
test_table <- function(n_tests, n_samples) {
  results <- numeric(n_tests)
  for(i in 1:n_tests) {
    data <- rnorm(n_samples)
    results[i] <- ks.test(data, "pnorm")$p.value
  }
  power_level <- 1 - sum(results < 0.05) / n_tests
  return(power_level)
}
Tests_Samples <- c("10000, 10", "10000, 100", "10000, 1000", "10, 10000", "100, 10000", "1000, 10000")
Power_Level <- c(0, 0, 0, 0, 0, 0)
tab <- data.frame(Tests_Samples, Power_Level)
tab[1, "Power_Level"] <- test_table(10000, 10)
tab[2, "Power_Level"] <- test_table(10000, 100)
tab[3, "Power_Level"] <- test_table(10000, 1000)
tab[4, "Power_Level"] <- test_table(10, 10000)
tab[5, "Power_Level"] <- test_table(100, 10000)
tab[6, "Power_Level"] <- test_table(1000, 10000)
tab <- xtable(tab)
tab
```

```{r}
test_dgof <- function(n_tests, n_samples, rounded, B = 100) {
  results1 <- c()
  results2 <- c()
  results3 <- c()
  left <- -4-rounded*0.1
  y <- pnorm(seq(left, 4, by = rounded*0.1))
  sfun  <- stepfun(seq(-4, 4, by = rounded*0.1), y)
  for (i in 1:n_tests) {
    test <- round(rnorm(n_samples), rounded)
    results1[i] <- ks.test(test, sfun)$p.value
    results2[i] <- ks.test(test, sfun, simulate.p.value = TRUE, B = B)$p.value
    results3[i] <- ks.test(test, "pnorm")$p.value
  }
  list(results1 = results1, results2 = results2, results3 = results3)
}

test1 <- suppressWarnings(test_dgof(1000, 30, 4))
test2 <- suppressWarnings(test_dgof(1000, 30, 3))
test3 <- suppressWarnings(test_dgof(1000, 30, 2))
test4 <- suppressWarnings(test_dgof(1000, 30, 1))

hist1 <- test1$results1
hist2 <- test1$results2
hsit3 <- test1$results3
hist4 <- test2$results1
hist5 <- test2$results2
hist6 <- test2$results3
hist7 <- test3$results1
hist8 <- test3$results2
hist9 <- test3$results3
hist10 <- test4$results1
hist11 <- test4$results2
hist12 <- test4$results3

histogram <- c(rep(1:12, each = 1000))
p_values <- c(hist1, hist2, hist3, hist4, hist5, hist6, hist7, hist8, hist9, hist10, hist11, hist12)
results <- data_frame(p_values, histogram)
hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="gray", fill="white", bins = 20)
hist + facet_wrap(.~histogram, scales = "free_y", ncol = 3)
```

```{r}
test_dgofsimulate <- function(n_tests, n_samples, rounded, B = 100) {
  results1 <- c()
  results2 <- c()
  left <- -4-rounded*0.1
  y <- pnorm(seq(left, 4, by = rounded*0.1))
  sfun  <- stepfun(seq(-4, 4, by = rounded*0.1), y)
  for (i in 1:n_tests) {
    test <- round(rnorm(n_samples), rounded)
    results1[i] <- ks.test(test, sfun)$p.value
    results2[i] <- ks.test(test, sfun, simulate.p.value = TRUE, B = B)$p.value
  }
  list(results1 = results1, results2 = results2)
}

test1 <- suppressWarnings(test_dgofsimulate(1000, 100, 1, 100))
test2 <- suppressWarnings(test_dgofsimulate(1000, 100, 2, 100))

hist1 <- test1$results1
hist2 <- test1$results2
hist3 <- test2$results1
hist4 <- test2$results2
histogram <- c(rep("hist1", 1000), rep("hist2", 1000), rep("hist3", 1000), rep("hist4", 1000))
p_values <- c(hist1, hist2, hist3, hist4)
results <- data_frame(p_values, histogram)
hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="gray", fill="white", bins = 20)
hist + facet_wrap(.~histogram, scales = "free_y")
```

```{r}
test_parametric <- function(x, B = 200) {
  mu <- mean(x)
  sigma <- sd(x)
  stat <- ks.test(x, "pnorm", mu, sigma)$statistic
  n <- length(x)
  stat.b <- double(B)
  for (i in 1:B) {
    x.b <- rnorm(n, mu, sigma)
    mu.b <- mean(x.b)
    sigma.b <- sd(x.b)
    stat.b[i] <- ks.test(x.b, "pnorm", mu.b, sigma.b)$statistic
  }
  p.value <- (sum(stat.b >= stat) + 0.5) / (B + 1)
  list(statistics = stat, p.value = p.value, 
       estimate = c(mean = mu, sd = sigma),
       stat.sim = stat.b)
}

pvals_parametric <- replicate(1000, test_parametric(rnorm(100), B = 200)$p.value)

test_ks <- function(x) {
  p.value <- ks.test(x, "pnorm", mean = mean(x), sd = sd(x))$p.value
  list(p.value = p.value)
}

pvals_regular <- replicate(1000, test_ks(rnorm(100))$p.value)

histogram <- c(rep("parametric", 1000), rep("regular", 1000))
p_values <- c(pvals_parametric, pvals_regular)
results <- data_frame(p_values, histogram)
hist <- ggplot(results, aes(x = p_values)) + geom_histogram(color="gray", fill="white", bins = 20)
hist + facet_wrap(.~histogram, scales = "free_y")

ks.test(pvals_parametric, "punif")
ks.test(pvals_regular, "punif")
```